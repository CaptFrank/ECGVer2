// this example is public domain. enjoy!
// www.ladyada.net/learn/sensors/thermocouple

//defines/includes
#include "max6675.h"
#define potPin 0
#define LightPin 1
#define ECGPin 4
#define ECG_LED 5
#define threshold 10
#define PWR_PIN 6
#define Red 2
#define redLED 3
#define irLED 4
#define Battpin 5
#define Resppin 2
#define receivePin 23

//initalization of vars

int z=0;
double temp=0;
int byteGPS = -1;
char buffer[300] = "";
char commandGPR[7] = "$GPRMC";
int count = 0;
int good = 0;
int counter = 0;
int indices[13];

int thermoDO = 10;
int thermoCS = 11;
int thermoCLK = 12;

 /*________________________________________________________________________________*/

MAX6675 thermocouple(thermoCLK, thermoCS, thermoDO);
int vccPin = 9;
int gndPin = 8;
  
 /*________________________________________________________________________________*/
  
void setup() {
  Serial1.begin(115200);
  Serial2.begin(4800);
  // use Arduino pins 
  pinMode(receivePin, OUTPUT);
  pinMode(vccPin, OUTPUT); digitalWrite(vccPin, HIGH);
  pinMode(gndPin, OUTPUT); digitalWrite(gndPin, LOW);
  pinMode(PWR_PIN, OUTPUT); digitalWrite(PWR_PIN, HIGH);
  pinMode(ECG_LED, OUTPUT); digitalWrite(ECG_LED, LOW);
  pinMode(ECGPin, INPUT); digitalWrite(ECGPin, LOW);
  pinMode(irLED, OUTPUT); digitalWrite(irLED, LOW);
  pinMode(redLED, OUTPUT); digitalWrite(redLED, LOW);
  pinMode(LightPin, INPUT);
  
  for (int i = 0; i < 300; i++){
   buffer[i] = ' '; 
  }
  
  // wait for MAX chip to stabilize
  delay(100);
}

 /*________________________________________________________________________________*/

void loop() {
  // basic readout test, just print the current temp
  Serial1.print("!");
  Serial1.print("Lig:");
  Serial1.print((double)analogRead(LightPin));
  if (z==1000){
    Serial1.print("Tem:");
    temp =thermocouple.readCelsius()-6.0;
    Serial1.print((double)(thermocouple.readCelsius()-6.0));
    z=0;
  }
  else{
    Serial1.print("Tem:");
    Serial1.print(temp);
  }
  Serial1.print("ECG:");
  Serial1.print((double)analogRead(ECGPin));
  Serial1.print("POT:");
  digitalWrite(redLED, HIGH);
  Serial1.print(pulseIn(Red, HIGH));
  digitalWrite(redLED, LOW);
  Serial1.print("BAT:");
  Serial1.print((double)analogRead(Battpin));
  Serial1.print("IRL:");
  digitalWrite(irLED, HIGH);
  Serial1.print((double)pulseIn(Red, HIGH));
  digitalWrite(irLED, LOW);
  Serial1.print("LOW:");
  Serial1.print((double)pulseIn(Red, HIGH));
  Serial1.print("RES:");
  Serial1.print((double)analogRead(Resppin));
 
  getGPSSentence();
  Serial1.println("\n");
  z+=10;
}

 /*________________________________________________________________________________*/


void select(){
  
  // Select the inputs...
}

String getGPSSentence(){
    digitalWrite(receivePin, HIGH);
    Serial1.print("|");
    byteGPS = Serial2.read();
    if(byteGPS == -1){
       delay(100); 
    }
    else{
       buffer[counter] = byteGPS;
       counter++;
       Serial2.print(byteGPS, BYTE);
       if(byteGPS == 13){
           digitalWrite(receivePin, LOW);
           count = 0;
           good = 0;
           
           for(int i = 1; i < 7; i++){
             if(buffer[i] == commandGPR[i - 1]){
               good++;
             }
           }
           if(good == 6){
             for(int i = 0; i < 300; i++){
               Serial1.print(buffer[i]);
             }
          }
       }
    }
  Serial1.print("\n");
}